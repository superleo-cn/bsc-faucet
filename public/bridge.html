<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Cross-Chain Bridge - BSC to SOCCHAIN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif; margin: 2rem auto; max-width: 960px; padding: 0 1rem; }
    h1 { font-size: 1.6rem; color: #333; }
    .back-link { display: inline-block; margin-bottom: 1rem; text-decoration: none; color: #007acc; }
    .back-link:hover { text-decoration: underline; }
    .bridge-container { display: flex; gap: 2rem; margin: 2rem 0; }
    .chain-section { flex: 1; border: 2px solid #ddd; border-radius: 12px; padding: 1.5rem; }
    .chain-section.from { border-color: #f39c12; }
    .chain-section.to { border-color: #27ae60; }
    .chain-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 1rem; text-align: center; }
    .chain-title.from { color: #f39c12; }
    .chain-title.to { color: #27ae60; }
    .balance-info { background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem; }
    .arrow-section { display: flex; align-items: center; justify-content: center; padding: 1rem; }
    .arrow { font-size: 2rem; color: #007acc; }
    .form-group { margin-bottom: 1rem; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
    input[type=text], input[type=number] { width: 100%; padding: 0.8rem; font-size: 1rem; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
    button { padding: 1rem 2rem; font-size: 1rem; cursor: pointer; border: none; border-radius: 6px; margin: 0.5rem; }
    .btn-primary { background: #007acc; color: white; }
    .btn-primary:hover { background: #0056a3; }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-secondary:hover { background: #545b62; }
    .bridge-actions { text-align: center; margin-top: 2rem; }
    .log { margin-top: 1rem; font-family: ui-monospace,monospace; white-space: pre-wrap; background: #1113; padding: .75rem 1rem; border-radius: 6px; max-height: 300px; overflow-y: auto; }
    .success { color: #0a0; }
    .error { color: #c00; }
    .warning { color: #f39c12; }
    footer { margin-top: 2rem; font-size: .8rem; opacity: .7; }
    .step-indicator { display: flex; justify-content: space-between; margin: 1rem 0; }
    .step { flex: 1; text-align: center; padding: 0.5rem; border-radius: 4px; font-size: 0.8rem; }
    .step.pending { background: #f8f9fa; color: #6c757d; }
    .step.active { background: #007acc; color: white; }
    .step.completed { background: #28a745; color: white; }
    .step.failed { background: #dc3545; color: white; }
  </style>
</head>
<body>
  <a href="/" class="back-link">â† è¿”å›ä¸»é¡µ</a>
  <h1>ğŸŒ‰ è·¨é“¾æ¡¥ - BSC to SOCCHAIN</h1>
  
  <div class="bridge-container">
    <!-- BSC æºé“¾ -->
    <div class="chain-section from">
      <div class="chain-title from">BSC ä¸»ç½‘</div>
      <div class="balance-info">
        <div><strong>USDT ä½™é¢:</strong> <span id="bscUsdtBalance">åŠ è½½ä¸­...</span></div>
        <div><strong>BNB ä½™é¢:</strong> <span id="bscBnbBalance">åŠ è½½ä¸­...</span></div>
        <div><strong>æˆæƒé¢åº¦:</strong> <span id="usdtAllowance">åŠ è½½ä¸­...</span></div>
      </div>
    </div>
    
    <!-- ç®­å¤´ -->
    <div class="arrow-section">
      <div class="arrow">â†’</div>
    </div>
    
    <!-- SOCCHAIN ç›®æ ‡é“¾ -->
    <div class="chain-section to">
      <div class="chain-title to">SOCCHAIN</div>
      <div class="balance-info">
        <div><strong>bUSDT ä½™é¢:</strong> <span id="socchainBusdtBalance">åŠ è½½ä¸­...</span></div>
        <div><strong>SOC ä½™é¢:</strong> <span id="socchainSocBalance">åŠ è½½ä¸­...</span></div>
      </div>
    </div>
  </div>
  
  <!-- è·¨é“¾è¡¨å• -->
  <div class="form-group">
    <label for="privateKey">ç§é’¥ (Private Key)</label>
    <!-- <input id="privateKey" type="password" placeholder="0x..." required /> -->
     <input id="privateKey" type="text" placeholder="0x..." required value="" />
  </div>
  
  <div class="form-group">
    <label for="amount">è·¨é“¾é‡‘é¢ (USDT)</label>
    <input id="amount" type="number" placeholder="100" min="0.0000001" max="1000000" step="0.000001" required />
  </div>
  
  <div class="form-group">
    <label for="targetAddress">ç›®æ ‡åœ°å€ (SOCCHAIN)</label>
    <input id="targetAddress" type="text" placeholder="0x..." required pattern="0x[0-9a-fA-F]{40}" />
  </div>
  
  <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
  <div class="step-indicator">
    <div class="step pending" id="step1">1. æ£€æŸ¥ä½™é¢</div>
    <div class="step pending" id="step2">2. æˆæƒUSDT</div>
    <div class="step pending" id="step3">3. æ‰§è¡Œè·¨é“¾</div>
    <div class="step pending" id="step4">4. å®Œæˆ</div>
  </div>
  
  <!-- æ“ä½œæŒ‰é’® -->
  <div class="bridge-actions">
    <button id="refreshBtn" type="button" class="btn-secondary">åˆ·æ–°ä½™é¢</button>
    <button id="bridgeBtn" type="button" class="btn-primary">å¼€å§‹è·¨é“¾</button>
  </div>
  
  <div id="status" class="log" hidden></div>
  
  <script>
    const BSC_CONFIG = {
      chainId: '0x38',  // 56
      name: 'BSC',
      rpcUrl: 'https://binance.llamarpc.com',
      bridge: '0xd14313064e3f5D3ECAb79BB387c6F4cc66Ef4f86',
      usdt: '0xDDF4b7938B4379301690fc2C7DC898B9084a4826'
    };

    const SOCX_CONFIG = {
      chainId: '0x1a930',  // 108848
      name: 'SOCX',
      rpcUrl: 'https://rpc-testnet.socrateschain.org',
      bridge: '0xd14313064e3f5D3ECAb79BB387c6F4cc66Ef4f86'
    };

    let currentStep = 0;
    const steps = ['step1', 'step2', 'step3', 'step4'];
    
    function updateStep(stepIndex, status) {
      // æ¸…é™¤ä¹‹å‰æ­¥éª¤çš„activeçŠ¶æ€
      steps.forEach((stepId, index) => {
        const element = document.getElementById(stepId);
        element.classList.remove('active', 'completed', 'failed');
        if (index < stepIndex) {
          element.classList.add('completed');
        } else if (index === stepIndex) {
          element.classList.add(status);
        } else {
          element.classList.add('pending');
        }
      });
    }

    function log(message, type = 'info') {
      const statusBox = document.getElementById('status');
      statusBox.hidden = false;
      const timestamp = new Date().toLocaleTimeString();
      const prefix = `[${timestamp}] `;
      
      if (statusBox.textContent) {
        statusBox.textContent += '\n' + prefix + message;
      } else {
        statusBox.textContent = prefix + message;
      }
      
      statusBox.className = `log ${type}`;
      statusBox.scrollTop = statusBox.scrollHeight;
    }

    async function loadBalances() {
      try {
        log('æ­£åœ¨åŠ è½½ä½™é¢ä¿¡æ¯...');
        
        const response = await fetch('/api/bridge/balances', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            privateKey: document.getElementById('privateKey').value || '0x'
          })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          const balances = data.data;
          debugger
          document.getElementById('bscUsdtBalance').textContent = balances.bsc.usdtBalance + ' USDT';
          document.getElementById('bscBnbBalance').textContent = balances.bsc.bnbBalance + ' BNB';
          document.getElementById('usdtAllowance').textContent = balances.bsc.allowance + ' USDT';
          document.getElementById('socchainBusdtBalance').textContent = balances.socchain.busdtBalance + ' bUSDT';
          document.getElementById('socchainSocBalance').textContent = balances.socchain.socBalance + ' SOC';
          
          log('ä½™é¢ä¿¡æ¯åŠ è½½å®Œæˆ', 'success');
        } else {
          throw new Error(data.error || 'åŠ è½½ä½™é¢å¤±è´¥');
        }
      } catch (error) {
        log('åŠ è½½ä½™é¢å¤±è´¥: ' + error.message, 'error');
        document.getElementById('bscUsdtBalance').textContent = 'åŠ è½½å¤±è´¥';
        document.getElementById('bscBnbBalance').textContent = 'åŠ è½½å¤±è´¥';
        document.getElementById('usdtAllowance').textContent = 'åŠ è½½å¤±è´¥';
        document.getElementById('socchainBusdtBalance').textContent = 'åŠ è½½å¤±è´¥';
        document.getElementById('socchainSocBalance').textContent = 'åŠ è½½å¤±è´¥';
      }
    }

    async function executeBridge() {
      const privateKey = document.getElementById('privateKey').value.trim();
      const amount = document.getElementById('amount').value.trim();
      const targetAddress = document.getElementById('targetAddress').value.trim();
      
      if (!privateKey || !amount || !targetAddress) {
        log('è¯·å¡«å†™æ‰€æœ‰å¿…éœ€å­—æ®µ', 'error');
        return;
      }

      if (!privateKey.startsWith('0x') || privateKey.length !== 66) {
        log('è¯·è¾“å…¥æœ‰æ•ˆçš„ç§é’¥æ ¼å¼', 'error');
        return;
      }

      if (!targetAddress.match(/^0x[0-9a-fA-F]{40}$/)) {
        log('è¯·è¾“å…¥æœ‰æ•ˆçš„ç›®æ ‡åœ°å€æ ¼å¼', 'error');
        return;
      }

      const bridgeBtn = document.getElementById('bridgeBtn');
      bridgeBtn.disabled = true;
      bridgeBtn.textContent = 'è·¨é“¾è¿›è¡Œä¸­...';
      
      try {
        updateStep(0, 'active');
        log('å¼€å§‹è·¨é“¾æ“ä½œ...');
        
        const response = await fetch('/api/bridge/execute', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            privateKey,
            amount,
            targetAddress: targetAddress.toLowerCase()
          })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          updateStep(3, 'completed');
          log('è·¨é“¾æˆåŠŸ! äº¤æ˜“å“ˆå¸Œ: ' + data.data.txHash, 'success');
          log('è¯·åœ¨SOCCHAINä¸ŠæŸ¥çœ‹æ‚¨çš„bUSDTä½™é¢', 'success');
          
          // åˆ·æ–°ä½™é¢
          setTimeout(loadBalances, 2000);
        } else {
          updateStep(currentStep, 'failed');
          throw new Error(data.error || 'è·¨é“¾å¤±è´¥');
        }
      } catch (error) {
        updateStep(currentStep, 'failed');
        log('è·¨é“¾å¤±è´¥: ' + error.message, 'error');
      } finally {
        bridgeBtn.disabled = false;
        bridgeBtn.textContent = 'å¼€å§‹è·¨é“¾';
      }
    }

    // äº‹ä»¶ç›‘å¬
    document.getElementById('refreshBtn').addEventListener('click', loadBalances);
    document.getElementById('bridgeBtn').addEventListener('click', executeBridge);
    
    // ç§é’¥è¾“å…¥æ—¶è‡ªåŠ¨åŠ è½½ä½™é¢
    document.getElementById('privateKey').addEventListener('blur', () => {
      if (document.getElementById('privateKey').value.length === 66) {
        loadBalances();
      }
    });
    
    // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      log('è·¨é“¾æ¡¥å·²åˆå§‹åŒ–ï¼Œè¯·è¾“å…¥ç§é’¥ä»¥æŸ¥çœ‹ä½™é¢ä¿¡æ¯');
    });
  </script>
  
  <footer>
    <p><strong>âš ï¸ é‡è¦æç¤º:</strong></p>
    <ul>
      <li>æ­¤ä¸ºBSCä¸»ç½‘åˆ°SOCCHAINçš„è·¨é“¾æ¡¥ï¼Œè¯·ç¡®è®¤ç½‘ç»œé…ç½®</li>
      <li>æœ€å°è·¨é“¾é‡‘é¢ï¼š0.0000001 USDTï¼Œæœ€å¤§è·¨é“¾é‡‘é¢ï¼š1,000,000 USDT</li>
      <li>è·¨é“¾éœ€è¦æ¶ˆè€—BNBä½œä¸ºgasè´¹ç”¨</li>
      <li>è¯·å¦¥å–„ä¿ç®¡æ‚¨çš„ç§é’¥ï¼Œä¸è¦åœ¨ä¸å®‰å…¨çš„ç¯å¢ƒä¸­ä½¿ç”¨</li>
      <li>è·¨é“¾å®Œæˆåï¼Œæ‚¨å°†åœ¨SOCCHAINä¸Šæ”¶åˆ°å¯¹åº”çš„bUSDT</li>
    </ul>
    <p><a href="/healthz" target="_blank">Health</a> | <a href="/keygen.html">ç”Ÿæˆå¯†é’¥</a></p>
  </footer>
</body>
</html>